{% extends "adminpanel/admin_base.html" %}
{% block title %}Collection Management{% endblock %}
{% block content %}
<main class="min-h-screen bg-[#0b1f16]">
  <div class="max-w-7xl mx-auto px-6 py-10 space-y-6">

    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-white">Category Management</h1>
        <p class="text-green-200 text-sm">
          Organize your inventory structure and product classification
        </p>
      </div>
      <a href="{% url 'adminpanel:add-category' %}">
      <button class="bg-green-500 hover:bg-green-600 text-white px-5 py-2.5 rounded-xl font-semibold flex items-center gap-2 shadow">
        <span class="material-symbols-outlined">add</span>
        Add Category
      </button>
      </a>
    </div>

    <!-- Card -->
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">

      <!-- Controls -->
      <div class="p-5 border-b flex flex-col md:flex-row gap-4">
        <div class="relative flex-1">
          <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
            search
          </span>
          <input
            class="w-full h-11 pl-11 pr-4 rounded-lg border border-gray-200 focus:ring-green-500 focus:border-green-500"
            placeholder="Search categories…"
          />
        </div>

        <select class="h-11 px-4 rounded-lg border border-gray-200">
          <option>All Statuses</option>
          <option>Active</option>
          <option>Draft</option>
        </select>
      </div>

      <!-- Table -->
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-50 text-gray-600">
            <tr>
              <th class="px-6 py-4 text-left">ID</th>
              <th class="px-6 py-4 text-left">Category</th>
              <th class="px-6 py-4 text-left">Slug</th>
              <th class="px-6 py-4 text-left">Products</th>
              <th class="px-6 py-4 text-left">Status</th>
              <th class="px-6 py-4 text-right">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y">
            <tr class="hover:bg-background-light/50 transition-colors group">
<td class="px-6 py-4 text-sm text-text-secondary font-mono">#001</td>
<td class="px-6 py-4">
<div class="flex items-center gap-3">
<div class="size-10 rounded-lg bg-cover bg-center bg-gray-100 border border-[#d1e6d9]" data-alt="Abstract soft pink gradient representing dresses category" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCYmxlFi6ORLZGKDEb8V14ycTFaWYdb6BXAdBdK9vuX0fia_n7cUY0eR-rNZWQ43jyA6LkFbd3iXraMhynUeb76hK_vKrWzcdrxH92ZGjqTYq32tre8jWVWoFGep3y_MZ5nOnkPx8Ck3oR36AFBqI_8eW2JwhmXXW-pTA3cGDF_p7UpXPIi2MYUARkFzSz9teTLXZXbHqYgIOz5u1CtvIxmK-sAVJtCgj7uKyKBLbNuLIWSz5x488eTHA8dQeK-iD98cAmFY-7IIqY");'></div>
<span class="text-sm font-bold text-text-main">Dresses</span>
</div>
</td>
<td class="px-6 py-4 text-sm text-text-secondary font-medium">/dresses</td>
<td class="px-6 py-4 text-sm text-text-main font-medium">240 items</td>
<td class="px-6 py-4">
<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-primary/10 text-primary border border-primary/20">
                                                Active
                                            </span>
</td>
<td class="px-6 py-4 text-right">
<div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
<button class="size-8 flex items-center justify-center rounded-full hover:bg-primary/10 text-text-secondary hover:text-primary transition-colors" title="Edit">
<span class="material-symbols-outlined text-[18px]">edit</span>
</button>
<button class="size-8 flex items-center justify-center rounded-full hover:bg-red-50 text-text-secondary hover:text-red-500 transition-colors" title="Delete">
<span class="material-symbols-outlined text-[18px]">delete</span>
</button>
</div>
</td>
</tr>
             
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="px-6 py-4 flex justify-between items-center bg-gray-50">
        <p class="text-sm text-gray-500">
          Showing <b>1–5</b> of <b>24</b> results
        </p>

        <div class="flex items-center gap-2">
          <button class="px-3 py-1 rounded-lg hover:bg-gray-200">‹</button>
          <button class="px-3 py-1 rounded-lg bg-green-500 text-white">1</button>
          <button class="px-3 py-1 rounded-lg hover:bg-gray-200">2</button>
          <button class="px-3 py-1 rounded-lg hover:bg-gray-200">3</button>
          <span>…</span>
          <button class="px-3 py-1 rounded-lg hover:bg-gray-200">12</button>
          <button class="px-3 py-1 rounded-lg hover:bg-gray-200">›</button>
        </div>
      </div>

    </div>
  </div>
</main>
<script>
        document.addEventListener("DOMContentLoaded", function () {

            /* =========================================================
               MAIN PRODUCT IMAGE (FIXED TO USE Django field)
               ========================================================= */

            const uploadTrigger = document.getElementById("uploadTrigger");
            const productImageInput = document.getElementById("id_main_image");

            let cropper = null;
            let activeInput = productImageInput;

            const cropModal = document.getElementById("cropperModal");
            const cropImage = document.getElementById("cropperImage");
            const cropConfirmBtn = document.getElementById("cropConfirm");
            const cropCancelBtn = document.getElementById("cropCancel");
            const previewContainer = document.getElementById("mainImagePreview");

            /* NEW: modal elements */
            const imagePreviewModal = document.getElementById("imagePreviewModal");
            const imagePreviewModalImg = document.getElementById("imagePreviewModalImg");
            const mainImagePreviewRow = document.getElementById("mainImagePreviewRow");



            /* OPEN CROPPER WHEN FILE SELECTED */
            productImageInput.addEventListener("change", function () {
                if (!this.files || !this.files[0]) return;

                const file = this.files[0];

                if (!file.type.startsWith("image/")) {
                    alert("Please select a valid image file.");
                    this.value = "";
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    cropImage.src = e.target.result;
                    cropModal.classList.remove("hidden");

                    if (cropper) cropper.destroy();

                    cropper = new Cropper(cropImage, {
                        aspectRatio: 4 / 5,
                        viewMode: 0,
                        dragMode: "move",
                        autoCropArea: 0.9,
                        background: false,
                        guides: true,
                        center: true,
                        highlight: false,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false,
                    });
                };

                reader.readAsDataURL(file);
            });

            /* CONFIRM CROP */
            cropConfirmBtn.addEventListener("click", function () {
                if (!cropper || !activeInput) return;

                cropper.getCroppedCanvas({
                    width: 1200,
                    height: 1500,
                }).toBlob(blob => {
                    if (!blob) return;

                    const croppedFile = new File(
                        [blob],
                        "cropped.jpg",
                        { type: "image/jpeg" }
                    );

                    const dt = new DataTransfer();
                    dt.items.add(croppedFile);
                    activeInput.files = dt.files;

                    showPreview(croppedFile);

                    cropper.destroy();
                    cropper = null;
                    cropModal.classList.add("hidden");
                }, "image/jpeg", 0.9);
            });

            /* CANCEL CROP */
            cropCancelBtn.addEventListener("click", function () {
                if (cropper) cropper.destroy();
                cropper = null;

                if (activeInput) activeInput.value = "";
                cropModal.classList.add("hidden");
            });

            /* PREVIEW + DELETE + STORE URL FOR MODAL */

            function activatePreview(src, name = "") {
                const previewContainer = document.getElementById("mainImagePreview");
                const img = document.getElementById("mainImagePreviewImg");
                const removeBtn = document.getElementById("mainImageRemove");
                const nameEl = previewContainer.querySelector("p.text-xs.font-medium");

                // show preview
                previewContainer.classList.remove("hidden");

                // set image
                img.src = src;

                // filename
                if (name && nameEl) {
                    nameEl.textContent = name;
                }

                // enable large preview
                if (imagePreviewModalImg) {
                    imagePreviewModalImg.dataset.src = src;
                }

                // delete button (UI only)
                if (removeBtn) {
                    removeBtn.onclick = function (e) {
                        e.stopPropagation();
                        previewContainer.classList.add("hidden");
                        img.src = "";
                        productImageInput.value = "";
                    };
                }
            }

            function showPreview(file) {
                const objectUrl = URL.createObjectURL(file);
                activatePreview(objectUrl, file.name);
            }

            /* NEW: open/close big preview */
            if (mainImagePreviewRow && imagePreviewModal && imagePreviewModalImg) {
                mainImagePreviewRow.addEventListener("click", function () {
                    const src = imagePreviewModalImg.dataset.src;
                    if (!src) return;
                    imagePreviewModalImg.src = src;
                    imagePreviewModal.classList.remove("hidden");
                });

                imagePreviewModal.addEventListener("click", function (e) {
                    if (e.target === imagePreviewModal) {
                        imagePreviewModal.classList.add("hidden");
                        imagePreviewModalImg.src = "";
                    }
                });
            }

            // EDIT MODE: show existing main image if provided by Django
            if (window.existingMainImage) {
                activatePreview(
                    window.existingMainImage.url,
                    window.existingMainImage.name
                );
            }

        });
    </script>
{% endblock %}
